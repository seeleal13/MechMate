{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Edit Vehicle: {{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.license_plate }})</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.make.label }} {{ form.make(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.model.label }} {{ form.model(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.year.label }} {{ form.year(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.license_plate.label }} {{ form.license_plate(class="form-control", placeholder="Enter license plate") }}
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mt-3">Back to Dashboard</a>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const makeSelect = document.querySelector('#make');
        const modelSelect = document.querySelector('#model');
        const yearSelect = document.querySelector('#year');

        function populateModels(make, selectedModel) {
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            if (make) {
                fetch(`/api/models/${make}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model[0];
                            option.text = model[1];
                            if (model[0] === selectedModel) {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                        if (selectedModel) {
                            populateYears(make, selectedModel, '{{ form.year.data | safe }}');
                        }
                    })
                    .catch(error => console.error('Error fetching models:', error));
            }
        }

        function populateYears(make, model, selectedYear) {
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            if (make && model) {
                fetch(`/api/years/${make}/${model}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year[0];
                            option.text = year[1];
                            if (year[0] === selectedYear) {
                                option.selected = true;
                            }
                            yearSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching years:', error));
            }
        }

        const selectedMake = '{{ form.make.data | safe }}';
        const selectedModel = '{{ form.model.data | safe }}';
        if (selectedMake) {
            populateModels(selectedMake, selectedModel);
        }

        makeSelect.addEventListener('change', function() {
            populateModels(this.value, '');
        });

        modelSelect.addEventListener('change', function() {
            const make = makeSelect.value;
            const model = this.value;
            populateYears(make, model, '');
        });
    });
</script>
{% endblock %}